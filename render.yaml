services:
  - type: web
    name: mapraqti-forum
    env: node
    plan: starter
    
    # אנחנו אומרים ל-Render במפורש להשתמש במאגר הרשמי
    repo: https://github.com/NodeBB/NodeBB.git
    
    # אנחנו בוחרים גרסה יציבה ספציפית
    branch: v3.9.4 # ודא שזו הגרסה האחרונה הזמינה ב-Tags של המאגר הרשמי
    
    healthCheckPath: /
    envVars:
      - key: url
        value: "https://mapraqti-forum.onrender.com" # נעדכן לדומיין סופי בהמשך
      - fromService:
          type: redis
          name: mapraqti-redis
          property: connectionString
        key: REDIS_URL

    # פקודת Build סופית ומתוקנת
    buildCommand: |
      # 1. התקן תלויות בתיקיית install תחילה
      cd install
      npm install --production
      cd ..

      # 2. כעת התקן תלויות בתיקייה הראשית
      npm install --production

      # 3. חלץ פרטי חיבור
      export REDIS_HOST=$(echo $REDIS_URL | sed -e 's/redis.*@//' -e 's/:.*//')
      export REDIS_PORT=$(echo $REDIS_URL | sed -e 's/.*://')
      export REDIS_PASSWORD=$(echo $REDIS_URL | sed -e 's/redis.*:\/\///' -e 's/@.*//')
      
      # 4. הרץ התקנה אוטומטית
      ./nodebb setup --no-prompt --database=redis --redis:host=$REDIS_HOST --redis:port=$REDIS_PORT --redis:password=$REDIS_PASSWORD
      
      # 5. בצע build סופי
      ./nodebb build
    
    startCommand: "./nodebb start"

  - type: redis
    name: mapraqti-redis
    plan: free
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru
