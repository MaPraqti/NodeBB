services:
  - type: web
    name: mapraqti-forum
    env: node
    plan: starter
    repo: https://github.com/YOUR_USERNAME/NodeBB.git # !!! החלף בשם המשתמש שלך
    branch: master
    healthCheckPath: /
    envVars:
      # משתנה זה נשאר, ונעדכן אותו לדומיין הסופי בשלב הבא
      - key: url
        value: "https://mapraqti-forum.onrender.com"
      
      # --- התיקון מתחיל כאן ---
      # 1. אנו מבקשים מ-Render את כל מחרוזת החיבור במשתנה אחד בשם REDIS_URL
      - fromService:
          type: redis
          name: mapraqti-redis
          property: connectionString # זהו המאפיין הנכון לפי השגיאה
        key: REDIS_URL

    # 2. פקודת ה-Build המתוקנת, שמפרקת את ה-URL לחלקים
    buildCommand: |
      # הפקודות הבאות משתמשות בכלי 'sed' כדי לחלץ את החלקים מה-URL
      # ויוצרות משתני סביבה חדשים ש-NodeBB יכול להשתמש בהם
      export REDIS_HOST=$(echo $REDIS_URL | sed -e 's/redis.*@//' -e 's/:.*//')
      export REDIS_PORT=$(echo $REDIS_URL | sed -e 's/.*://')
      export REDIS_PASSWORD=$(echo $REDIS_URL | sed -e 's/redis.*:\/\///' -e 's/@.*//')
      
      # כעת, נשתמש במשתנים החדשים בפקודות המקוריות
      cd install
      npm install --production
      cd ..
      ./nodebb setup --no-prompt --database=redis --redis:host=$REDIS_HOST --redis:port=$REDIS_PORT --redis:password=$REDIS_PASSWORD
      ./nodebb build
    # --- סוף התיקון ---
    
    startCommand: "./nodebb start"

  - type: redis
    name: mapraqti-redis
    plan: free
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru
